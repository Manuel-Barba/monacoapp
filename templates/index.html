<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Mesas</title>
    <!-- Cache busting: 2025-07-05 23:39 - VERSION SIN RESERVACIONES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f0f0;
            --container-bg: white;
            --text-color: #333;
            --area-bg: #fff;
            --area-border: #eee;
            --layout-bg: #f8f9fa;
            --shadow-color: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #fff;
            --area-bg: #333;
            --area-border: #444;
            --layout-bg: #2a2a2a;
            --shadow-color: rgba(0,0,0,0.3);
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            min-height: 100vh;
            position: relative;
        }
        
        /* Header superior */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #181c22 0%, #23272f 40%, #1a1d23 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            width: auto;
        }
        
        .logo-image {
            height: 100%;
            width: auto;
            max-width: 150px;
            filter: brightness(0) invert(1); /* Makes the logo white */
            transition: all 0.3s ease;
        }
        
        .logo-image:hover {
            filter: brightness(0) invert(0.9);
            transform: scale(1.05);
        }
        
        .header-title {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: #e6e6e6;
            letter-spacing: -0.5px;
            background: linear-gradient(90deg, #e6e6e6 0%, #b0b8c1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 70px;
            margin: 0;
            padding: 0;
            line-height: 1;
        }
        
        .header-nav {
            display: flex;
            align-items: center;
            gap: 20px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            font-size: .9rem;
            color: rgba(220, 225, 235, 0.8);
        }
        
        .header-nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .header-nav-item i {
            font-size: 1rem;
        }
        
        .header-nav-item:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .header-nav-item.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .header-nav-separator {
            color: rgba(255, 255, 255, 0.3);
            font-weight: 300;
            margin: 0 5px;
        }
        
        #fechaHoraHeader {
            color: rgba(220, 225, 235, 0.9);
            font-size: 0.9rem;
            font-weight: 300;
            cursor: default;
        }
        
        #fechaHoraHeader:hover {
            background: transparent;
            transform: none;
        }
        
        .live-indicator {
            width: 12px;
            height: 12px;
            background: #ff4444;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
            }
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-clean-btn {
            height: 45px;
            width: 45px;
            border: none;
            background: linear-gradient(90deg, rgba(40, 45, 55, 0.13) 0%, rgba(30, 33, 40, 0.08) 100%);
            color: rgba(220, 225, 235, 0.8);
            border: 1px solid rgba(60, 70, 90, 0.13);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .header-clean-btn:hover {
            background: linear-gradient(90deg, rgba(60, 70, 90, 0.18) 0%, rgba(30, 33, 40, 0.12) 100%);
            color: #fff;
            border-color: rgba(60, 70, 90, 0.22);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .header-clean-btn:active {
            transform: translateY(0);
        }
        
        /* Sidebar simplificado */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            width: 300px;
            height: calc(100vh - 60px);
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2a 50%, #0f1419 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.03);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .main-content {
            margin-left: 300px;
            margin-top: 60px;
            padding: 20px;
            min-height: calc(100vh - 60px);
            position: relative;
            width: calc(100% - 300px);
            box-sizing: border-box;
        }
        @media (max-width: 900px) {
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 8px;
            }
        }
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-sizing: border-box;
            overflow-x: auto;
        }
        @media (max-width: 900px) {
            .container {
                padding: 8px;
                border-radius: 0;
                font-size: 0.97em;
            }
        }
        
        .sidebar-header {
            padding: 0 30px 30px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .sidebar-title {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: #e6e6e6;
            margin: 0;
            letter-spacing: -0.5px;
            background: linear-gradient(90deg, #e6e6e6 0%, #b0b8c1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sidebar-subtitle {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.9rem;
            color: rgba(200, 210, 220, 0.5);
            margin: 8px 0 0 0;
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .sidebar-btn {
            width: 100%;
            height: 56px;
            border: none;
            background: transparent;
            color: rgba(220, 225, 235, 0.7);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            padding: 0 20px;
            border-radius: 16px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            font-size: 0.95rem;
            letter-spacing: 0.2px;
            overflow: hidden;
        }
        
        .sidebar-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, rgba(40, 45, 55, 0.18) 0%, rgba(30, 33, 40, 0.12) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 16px;
        }
        
        .sidebar-btn:hover {
            color: #fff;
            transform: translateX(4px);
        }
        
        .sidebar-btn:hover::before {
            opacity: 1;
        }
        
        .sidebar-btn.active {
            color: #fff;
            background: linear-gradient(90deg, rgba(60, 70, 90, 0.18) 0%, rgba(30, 33, 40, 0.12) 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-btn.active::before {
            opacity: 1;
        }
        
        .sidebar-btn i {
            font-size: 1.3rem;
            min-width: 24px;
            text-align: center;
            margin-right: 16px;
            transition: transform 0.3s ease;
        }
        
        .sidebar-btn:hover i {
            transform: scale(1.1);
        }
        
        .sidebar-btn span {
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        
        .sidebar-bottom {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: center;
        }
        
        .sidebar-bottom .sidebar-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
            color: #2c2c2c;
            border: 1px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(10px);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-bottom .sidebar-btn:hover {
            background: linear-gradient(135deg, #FFED4E 0%, #FFB347 50%, #FFA500 100%);
            color: #1a1a1a;
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }
        
        .sidebar-bottom .sidebar-btn::before {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
        }
        
        /* Estilos para las reservaciones en el sidebar */
        .sidebar-reservaciones {
            flex: 1;
            padding: 20px;
            padding-top: 5px;
            overflow-y: auto;
            max-height: calc(100vh - 160px);
        }
        
        /* Estilos personalizados para el scrollbar del sidebar */
        .sidebar-reservaciones::-webkit-scrollbar {
            width: 12px;
        }
        
        .sidebar-reservaciones::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin: 5px 0;
        }
        
        .sidebar-reservaciones::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(244, 243, 233, 0.6) 0%, rgba(255, 255, 255, 0.866) 100%);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .sidebar-reservaciones::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(244, 243, 233, 0.6) 0%, rgba(255, 255, 255, 0.866) 100%);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .sidebar-reservaciones::-webkit-scrollbar-corner {
            background: transparent;
        }
        
        /* Estilos para Firefox */
        .sidebar-reservaciones {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 254, 245, 0.787) rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-reservaciones-title {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: #e6e6e6;
            margin: 0 0 15px 0;
            text-align: left;
            letter-spacing: -0.3px;
        }
        
        .sidebar-filtro {
            margin-bottom: 20px;
            
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }
        
        .filtro-area-select {
            width: 80%;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(40, 45, 55, 0.8) 0%, rgba(30, 33, 40, 0.6) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e6e6e6;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            text-align: left;
        }
        
        .filtro-area-select:hover {
            background: linear-gradient(135deg, rgba(50, 55, 65, 0.9) 0%, rgba(40, 43, 50, 0.7) 100%);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .filtro-area-select:focus {
            outline: none;
            background: linear-gradient(135deg, rgba(60, 70, 90, 0.9) 0%, rgba(50, 55, 65, 0.7) 100%);
            border-color: rgba(255, 193, 7, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }
        
        .filtro-area-select option {
            background: #2d2d2d;
            color: #e6e6e6;
            padding: 10px;
        }
        
        .reservacion-item {
            background: linear-gradient(135deg, rgba(40, 45, 55, 0.15) 0%, rgba(30, 33, 40, 0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .reservacion-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 12px 12px 0 0;
        }
        
        .reservacion-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, rgba(60, 70, 90, 0.2) 0%, rgba(40, 45, 55, 0.15) 100%);
        }
        
        .reservacion-hora {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 8px;
            text-align: left;
            background: rgba(76, 175, 80, 0.1);
            padding: 5px 10px;
            border-radius: 8px;
            display: inline-block;
            width: 100%;
            box-sizing: border-box;
        }
        
        .reservacion-nombre {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: #e6e6e6;
            margin-bottom: 5px;
            text-align: left;
        }
        
        .reservacion-detalles {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.85rem;
            color: rgba(220, 225, 235, 0.8);
            line-height: 1.4;
        }
        
        .reservacion-detalle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 3px;
        }
        
        .reservacion-detalle i {
            width: 16px;
            text-align: center;
            color: rgba(220, 225, 235, 0.6);
        }
        
        .reservacion-area {
            display: inline-block;
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .reservacion-mesa {
            display: inline-block;
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .reservacion-telefono {
            color: #2196F3;
            font-weight: 500;
        }
        
        .reservacion-personas {
            color: #ffc107;
            font-weight: 500;
        }
        
        .reservacion-nota {
            color: #d900ff;
            font-weight: 500;
            
        }
        
        .no-reservaciones {
            text-align: left;
            color: rgba(220, 225, 235, 0.6);
            font-style: italic;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.95rem;
        }
        
        .reservacion-proxima {
            border-left: 4px solid #FF9800;
        }
        
        .reservacion-proxima::before {
            background: linear-gradient(90deg, #FF9800, #F57C00) !important;
        }
        
        .reservacion-proxima .reservacion-hora {
            color: #FF9800;
            background: rgba(255, 152, 0, 0.1);
        }
        
        .reservacion-pasada {
            opacity: 0.6;
            border-left: 4px solid #FF9800;
            position: relative;
        }
        
        .reservacion-pasada::before {
            background: linear-gradient(90deg, #FF9800, #F57C00) !important;
        }
        
        .reservacion-pasada .reservacion-hora {
            color: #FF9800;
            background: rgba(158, 158, 158, 0.1);
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .reservacion-pasada .reservacion-hora::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #FF9800;
            border-radius: 50%;
            opacity: 0.6;
            animation: pulse-orange 2s infinite;
            box-shadow: 0 0 6px rgba(255, 152, 0, 0.4);
            flex-shrink: 0;
        }
        
        @keyframes pulse-orange {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.6);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(255, 152, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }
        
        /* Estilos para modo oscuro */
        [data-theme="dark"] .reservacion-item {
            background: linear-gradient(135deg, rgba(60, 70, 90, 0.2) 0%, rgba(40, 45, 55, 0.15) 100%);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="dark"] .reservacion-item:hover {
            background: linear-gradient(135deg, rgba(80, 90, 110, 0.25) 0%, rgba(60, 70, 90, 0.2) 100%);
        }
        
        [data-theme="dark"] .reservacion-nombre {
            color: #ffffff;
        }
        
        [data-theme="dark"] .reservacion-detalles {
            color: rgba(255, 255, 255, 0.8);
        }
        
        [data-theme="dark"] .no-reservaciones {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Ajuste del contenido principal */
        .main-content {
            margin-left: 300px;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        h1, h2 {
            color: var(--text-color);
        }
        .areas-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .area-section {
            background-color: var(--area-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            position: relative;
        }
        .area-title {
            font-size: 1.5em;
            color: var(--text-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--area-border);
        }
        .area-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            background-color: var(--area-bg);
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        .area-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            color: var(--text-color);
        }
        .area-legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        .area-legend-color.disponible {
            background-color: #28a745;
        }
        .area-legend-color.ocupada {
            background-color: #dc3545;
        }
        .area-legend-color.reservada {
            background-color: #ffc107;
        }


        .restaurant-layout {
            display: grid;
            gap: 20px;
            padding: 20px;
            background-color: var(--layout-bg);
            border-radius: 8px;
        }
        .interior-layout {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            background: rgba(48, 48, 48, 0.05);
            
        }
        

        .jardin-layout {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            background: linear-gradient(90deg, rgba(48, 48, 48, 0.05) 50%, rgba(34, 139, 34, 0.2) 52%);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0);
        }
        .reservados-layout {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
            background: linear-gradient(135deg, rgba(103, 0, 112, 0.2) 0%, rgba(152, 19, 162, 0.2) 50%, rgba(112, 25, 108, 0.2) 100%);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0);
            backdrop-filter: blur(5px);
        }
        .mesa {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            margin: 0 auto;
        }
        .mesa.disponible {
            background-color: #28a745;
        }
        .mesa.ocupada {
            background-color: #dc3545;
        }
        .mesa.reservada {
            background-color: #ffc107;
            color: #000;
        }
        
        .mesa.reservada.ocupada-temporaria {
            background-color: #ffc107;
            color: #000;
            outline: 3px dashed #dc3545;
            outline-offset: 8px;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        .mesa-info {
            text-align: center;
        }
        .mesa-numero {
            font-size: 1.2em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .mesa-numero .mesa-icon {
            width: 16px;
            height: 16px;
            opacity: 0.8;
            filter: brightness(0) invert(1);
        }
        
        .mesa-icon-small {
            width: 14px;
            height: 14px;
            opacity: 0.8;
            filter: brightness(0) invert(1);
            vertical-align: middle;
            margin-right: 4px;
        }
        .mesa-capacidad {
            font-size: 0.9em;
        }
        .mesa-seleccionada {
            position: relative;
        }
        .deselect-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #dc3545;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            z-index: 1000;
        }
        .deselect-btn:hover {
            background-color: #c82333;
            transform: scale(1.1);
        }
        .deselect-btn:hover::after {
            content: 'Deseleccionar';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            margin-right: 8px;
        }

        .mesa-reservacion-info {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #666;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 100;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--layout-bg);
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .modal-header {
            background-color: var(--layout-bg);
        }
        [data-theme="dark"] .modal-header .modal-title {
            color: white;
        }
        
        /* Estilos para centrar el modal de reservaci√≥n */
        .modal-dialog {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .modal-content {
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        /* Asegurar que el modal est√© por encima de todo */
        .modal {
            z-index: 1002 !important;
        }
        
        .modal-backdrop {
            z-index: 1001 !important;
        }
        .popup-message {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: var(--container-bg);
            color: var(--text-color);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px var(--shadow-color);
            z-index: 1002;
            display: none;
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        .btn-actualizar {
            position: relative;
        }
        .btn-actualizar:hover::after {
            content: 'Actualizar manualmente';
            position: absolute;
            left: 50%;
            top: -30px;
            transform: translateX(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: nowrap;
            z-index: 1000;
        }
        .mesa-opciones {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        .mesa-opcion {
            background-color: #2c3e50;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .mesa-opcion:hover {
            background-color: #34495e;
            transform: scale(1.05);
        }
        .mesa-opcion.reservar {
            background-color: #1a5c2e;
            color: white;
        }
        .mesa-opcion.ocupar {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            animation: pulse-ocupar 2s infinite;
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 1001;
        }
        
        .mesa-opcion.ocupar:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
            z-index: 1001;
        }
        
        .mesa-opcion.ocupar-temp {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 7, 7, 0.3);
            animation: pulse-ocupar-temp 2s infinite;
            border: 2px solid rgba(0, 0, 0, 0);
            z-index: 1001;
        }
        
        .mesa-opcion.ocupar-temp:hover {
            background: linear-gradient(135deg, #9d222e 0%, #c82333 100%);
            box-shadow: 0 6px 20px rgba(255, 7, 7, 0.4);
            z-index: 1001;
        }
        
        .mesa-opcion.liberar-temp {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            z-index: 1001;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.055);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .mesa-opcion.liberar-temp:hover {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.102);
            z-index: 1001;
        }
        
        @keyframes pulse-ocupar-temp {
            0% {
                box-shadow: 0 4px 15px rgba(255, 7, 7, 0.3);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 4px 20px rgba(255, 7, 7, 0.5);
                transform: scale(1.02);
            }
            100% {
                box-shadow: 0 4px 15px rgba(255, 7, 7, 0.3);
                transform: scale(1);
            }
        }
        
        @keyframes pulse-ocupar {
            0% {
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 4px 20px rgba(220, 53, 69, 0.5);
                transform: scale(1.02);
            }
            100% {
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
                transform: scale(1);
            }
        }
        .btn-liberar {
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #dc3545;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            z-index: 1000;
        }
        .btn-liberar:hover {
            background-color: #c82333;
            transform: scale(1.1);
        }
        .btn-liberar:hover::after {
            content: 'Liberar';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            margin-right: 8px;
        }

        /* Bot√≥n de liberar reservaci√≥n en el sidebar */
        .btn-liberar-reservacion {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .btn-liberar-reservacion:hover {
            transform: scale(1.1);
        }
        
        .btn-liberar-reservacion:hover::after {
            content: 'Liberar Reservaci√≥n';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            margin-right: 8px;
        }
        
        /* Color naranja para reservaciones pr√≥ximas */
        .btn-liberar-reservacion.proxima {
            background-color: #FF9800;
        }
        
        .btn-liberar-reservacion.proxima:hover {
            background-color: #F57C00;
        }
        
        /* Color verde para reservaciones normales */
        .btn-liberar-reservacion.normal {
            background-color: #4CAF50;
        }
        
        .btn-liberar-reservacion.normal:hover {
            background-color: #45a049;
        }
        
        /* Color naranja para reservaciones activas (ya es hora) */
        .btn-liberar-reservacion.activa {
            background-color: #FF9800;
        }
        
        .btn-liberar-reservacion.activa:hover {
            background-color: #F57C00;
        }
        
        /* Ajustar posici√≥n del bot√≥n para reservaciones pasadas */
        .reservacion-pasada .btn-liberar-reservacion {
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            font-size: 10px;
        }

        /* Bot√≥n de unir mesas */
        .btn-unir {
            position: absolute;
            bottom: -10px;
            left: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            z-index: 1000;
        }
        
        .btn-unir:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }
        
        .btn-unir:hover::after {
            content: 'Unir Mesas';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            margin-left: 8px;
        }

        /* Bot√≥n de separar mesas */
        .btn-separar {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            z-index: 1000;
        }
        
        .btn-separar:hover {
            background-color: #545b62;
            transform: scale(1.1);
        }
        
        .btn-separar:hover::after {
            content: 'Separar Mesas';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            margin-left: 8px;
        }

        /* Indicador visual de mesa unida */
        .mesa-unida-indicador {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 123, 255, 0.9);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            z-index: 5;
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }

        /* Estilos para el modal de unir mesas */
        .mesa-card-unir {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .mesa-card-unir:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .mesa-card-unir.selected {
            border-color: #007bff;
            background-color: #f8f9ff;
        }

        .mesa-unir-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #dc3545;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 0.9em;
        }

        .mesa-numero-unir {
            font-weight: bold;
            font-size: 0.8em;
            line-height: 1;
        }

        .mesa-capacidad-unir {
            font-size: 0.7em;
            opacity: 0.9;
        }

        /* Estilos para loading circles */
        .area-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 8px;
            backdrop-filter: blur(2px);
        }

        [data-theme="dark"] .area-loading {
            background: rgba(45, 45, 45, 0.9);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        [data-theme="dark"] .loading-spinner {
            border: 4px solid #444;
            border-top: 4px solid #007bff;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }



        .area-section {
            position: relative;
        }

        .mesa-tooltip {
            position: absolute;
            bottom: -120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 340px;
            height: 110px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            white-space: normal;
        }

        .mesa-tooltip.show {
            opacity: 1;
            transform: translateX(-50%) translateY(5px);
        }

        .mesa-tooltip::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0);
        }

        .mesa-tooltip-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            text-align: center;
        }

        .mesa-tooltip-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #ffc400;
            text-align: center;
            line-height: 1.3;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mesa-tooltip-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.8rem;
            line-height: 1.4;
            flex-wrap: wrap;
        }

        .mesa-tooltip-info i {
            width: 30px;
            text-align: center;
            color: #ffc400;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .mesa-tooltip-info span {
            color: #ecf0f1;
            font-weight: 500;
            white-space: nowrap;
        }

        .mesa-tooltip-nota {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.8rem;
            line-height: 1.4;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mesa-tooltip-nota i {
            width: 30px;
            text-align: center;
            color: #d900ff;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .mesa-tooltip-nota span {
            color: #d900ff;
            font-weight: 500;
            text-align: center;
            white-space: normal;
        }

        h1 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 30px;
        }
        .mesa {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            margin: 0 auto;
        }
        .mesa.animating {
            animation: fadeIn 0.5s ease;
        }

        .reservation-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--area-bg);
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }
        [data-theme="dark"] .reservation-item {
            background-color: white;
            color: #333;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--layout-bg);
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-color);
        }
        [data-theme="dark"] .sidebar {
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%);
            border-right: 1px solid #333333;
        }

        [data-theme="dark"] .sidebar-btn {
            background: #2a2a2a;
        }

        [data-theme="dark"] .sidebar-btn:hover {
            background: #3a3a3a;
        }

        .sidebar-btn {
            width: 100%;
            height: 50px;
            border-radius: 12px;
            border: none;
            background: #333333;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
            padding: 0 15px;
            gap: 12px;
        }

        .sidebar-btn:hover {
            background: #404040;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .sidebar-btn.active {
            background: #4CAF50;
            color: #ffffff;
        }

        .sidebar-btn i {
            font-size: 1.4em;
            min-width: 20px;
            text-align: center;
        }

        .sidebar-btn span {
            font-size: 0.9em;
            font-weight: 500;
            text-align: left;
            line-height: 1;
        }

        /* Bot√≥n de limpiar fijo al fondo */
        .sidebar-bottom {
            margin-top: auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }



        /* Ajuste del contenido principal */
        .main-content {
            margin-left: 200px;
            padding: 20px;
            min-height: 100vh;
        }

        .popup-confirm {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px var(--shadow-color);
            z-index: 1002;
            text-align: center;
            min-width: 300px;
            color: var(--text-color);
        }
        .popup-confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .popup-confirm-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .popup-confirm-btn.confirm {
            background-color: #dc3545;
            color: white;
        }
        .popup-confirm-btn.cancel {
            background-color: #6c757d;
            color: white;
        }
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        
        .popup-mesas {
            display: none;
            position: static;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px var(--shadow-color);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
        }
        @media (max-width: 900px) {
            .popup-mesas {
                padding: 8px;
                border-radius: 0;
                font-size: 0.97em;
            }
        }
        
        .popup-mesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .popup-mesas-grid .mesa {
            width: 100px !important;
            height: 100px !important;
            min-width: 100px !important;
            min-height: 100px !important;
            margin: 0 auto;
            position: relative;
        }


        
        .popup-mesas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--area-border);
        }
        
        .popup-mesas-title {
            font-size: 1.5em;
            color: var(--text-color);
            margin: 0;
        }
        
        .popup-mesas-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }
        
        .popup-mesas-subheader {
            padding: 15px 20px;
            border-bottom: 1px solid var(--area-border);
            background-color: var(--layout-bg);
        }
        
        .popup-mesas-subheader .form-control {
            min-width: 200px;
        }
        
        .mesa-reservada-info {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffc107;
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 100;
        }





        .layout-flex {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            flex: 0 0 300px;
            width: 300px;
            height: calc(100vh - 60px);
            position: sticky;
            top: 60px;
            left: 0;
            z-index: 1000;
        }
        .main-content {
            flex: 1 1 0;
            min-width: 0;
            margin-left: 0;
            width: 100%;
            position: relative;
            margin-top: 60px;
            padding: 20px;
            min-height: calc(100vh - 60px);
            box-sizing: border-box;
        }
        @media (max-width: 900px) {
            .layout-flex {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            .main-content {
                margin-top: 0;
                padding: 8px;
            }
        }

        .reservacion-pantalla { min-height: 400px; }
        .area-option {
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            padding: 24px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafbfc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            position: relative;
        }
        .area-option.selected, .area-option:hover {
            border-color: #28a745;
            background: #f0f9f0;
            box-shadow: 0 4px 16px rgba(40,167,69,0.08);
        }
        .area-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
            color: #28a745;
        }
        .mesas-layout-container {
            display: grid;
            gap: 12px;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }
        .mesas-layout-container.interior {
            grid-template-columns: repeat(4, 1fr);
        }
        .mesas-layout-container.jardin {
            grid-template-columns: repeat(5, 1fr);
        }
        .mesas-layout-container.reservados {
            grid-template-columns: 1fr;
        }
        .mesa-modal {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            margin: 0 auto;
            font-size: 1em;
            border: 3px solid transparent;
            transition: all 0.2s;
            padding: 0;
        }
        .mesa-modal.disponible { background: #28a745; }
        .mesa-modal.reservada { background: #ffc107; color: #333; }
        .mesa-modal.ocupada { background: #dc3545; }
        .mesa-modal.selected, .mesa-modal:focus { border-color: #007bff; box-shadow: 0 0 0 2px #007bff44; }
        .mesa-modal .mesa-numero {
            font-size: 0.95em;
            line-height: 1.1;
            margin-bottom: 2px;
            font-weight: 600;
            word-break: break-word;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }
        
        .mesa-modal .mesa-numero .mesa-icon {
            width: 14px;
            height: 14px;
            opacity: 0.8;
            filter: brightness(0) invert(1);
        }
        .mesa-modal .mesa-capacidad {
            font-size: 0.8em;
            line-height: 1.1;
            font-weight: 400;
            word-break: break-word;
        }

        /* CSS extra para borde punteado y animaci√≥n de escala */
        .mesa-unida {
            border: 3px dashed #007bff !important;
            position: relative;
            z-index: 2;
        }
        .mesa-unida-hover {
            transform: scale(1.13);
            z-index: 10;
            transition: transform 0.2s cubic-bezier(.4,2,.6,1);
            box-shadow: 0 0 0 4px #007bff33;
        }
        .mesa-union-base {
            box-shadow: 0 0 0 4px #ffc10799;
            border: 3px solid #ffc107 !important;
        }

        /* Borde rojo separado para mesas agrupadas */
        .mesa-unida {
            position: relative;
        }
        
        .mesa-unida::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 3px dashed #dc3545;
            border-radius: 50%;
            z-index: 1;
            pointer-events: none;
        }
        
        .mesa-unida-hover {
            transform: scale(1.13);
            z-index: 10;
            transition: transform 0.2s cubic-bezier(.4,2,.6,1);
        }
        
        .mesa-unida-hover::before {
            border-color: #c82333;
            box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.2);
        }

        /* Estilos para los botones de ocasi√≥n */
        .row .col-3 .btn {
            transition: all 0.3s ease;
            border-radius: 8px !important;
            font-size: 1rem;
            padding: 10px 8px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .row .col-3 .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .row .col-3 .btn:active {
            transform: translateY(0);
        }

        .row .col-3 .btn.btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-color: #007bff;
            color: white;
            font-weight: 500;
        }

        .row .col-3 .btn.btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            border-color: #6c757d;
            color: white;
            font-weight: 500;
        }

        /* Estilo para el textarea cuando est√° deshabilitado */
        #notaReservacion[readonly] {
            background-color: #f8f9fa !important;
            border-color: #dee2e6;
            color: #6c757d;
        }


    </style>
</head>
<body>
    <!-- Header superior -->
    <div class="top-header">
        <div class="header-left">
            <div class="header-logo">
                <img src="/static/images/logo.svg" alt="M√≥naco" class="logo-image">
            </div>
            <div class="header-nav">
                <div class="header-nav-item active" id="btnEnVivo" onclick="mostrarVistaEnVivo()" title="Vista en vivo">
                    <span class="live-indicator"></span>
                    <span>En vivo</span>
                </div>

                <div class="header-nav-item" id="btnReservacionesFuturas" onclick="window.location.href='/reservaciones-futuras'" title="Reservaciones futuras">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Agenda de RSV</span>
                </div>

                <span class="header-nav-separator">|</span>
                <div class="header-nav-item" id="fechaHoraHeader">
                    <span> Bienvenido, hoy es</span>
                    <span id="fechaHoraActual"></span>
                </div>
            </div>
        </div>
        <!-- Bot√≥n de limpieza manual eliminado -->
    </div>


    <div class="layout-flex">
        <div class="sidebar">
            <div class="sidebar-reservaciones">
                <h3 class="sidebar-reservaciones-title">Reservaciones de Hoy</h3>
                <div class="sidebar-filtro">
                    <select id="filtroArea" class="filtro-area-select" onchange="filtrarReservacionesPorArea()">
                        <option value="todas">Todas las √°reas</option>
                        <option value="interior">Interior</option>
                        <option value="jardin">Jard√≠n</option>
                        <option value="reservados">Reservados</option>
                    </select>
                </div>
                <div id="sidebarReservaciones">
                    <div class="no-reservaciones">Cargando reservaciones...</div>
                </div>
            </div>
            
            <div class="sidebar-bottom">
                <button class="sidebar-btn" onclick="mostrarFormularioReservacion().catch(console.error)">
                    <i class="fas fa-calendar-plus"></i>
                    <span>Crear Reservaci√≥n</span>
                </button>
            </div>
        </div>
        <div class="main-content">
            <div class="container">
                <h1 style="font-weight: 600; font-size: 2.3rem;">Mesas y reservaciones</h1>
                
                <div class="areas-container">
                    <div class="area-section">
                        <h2 class="area-title">√Årea Interior</h2>
                        <div class="restaurant-layout interior-layout" id="interiorLayout"></div>
                        <div class="area-loading" id="interiorLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="area-legend">
                            <div class="area-legend-item">
                                <div class="area-legend-color disponible"></div>
                                <span>Disponible</span>
                            </div>
                            <div class="area-legend-item">
                                <div class="area-legend-color ocupada"></div>
                                <span>Ocupada</span>
                            </div>
                            <div class="area-legend-item">
                                <div class="area-legend-color reservada"></div>
                                <span>Reservada</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="area-section">
                        <h2 class="area-title">√Årea de Jard√≠n</h2>
                        <div class="restaurant-layout jardin-layout" id="jardinLayout"></div>
                        <div class="area-loading" id="jardinLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="area-legend">
                            <div class="area-legend-item">
                                <div class="area-legend-color disponible"></div>
                                <span>Disponible</span>
                            </div>
                            <div class="area-legend-item">
                                <div class="area-legend-color ocupada"></div>
                                <span>Ocupada</span>
                            </div>
                            <div class="area-legend-item">
                                <div class="area-legend-color reservada"></div>
                                <span>Reservada</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="area-section">
                        <h2 class="area-title">√Årea de Reservados</h2>
                        <div class="restaurant-layout reservados-layout" id="reservadosLayout"></div>
                        <div class="area-loading" id="reservadosLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="area-legend">
                            <div class="area-legend-item">
                                <div class="area-legend-color disponible"></div>
                                <span>Disponible</span>
                            </div>
                            <div class="area-legend-item">
                                <div class="area-legend-color ocupada"></div>
                                <span>Ocupada</span>
                            </div>
                            <div class="area-legend-item">
                                <div class="area-legend-color reservada"></div>
                                <span>Reservada</span>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #28a745;"></div>
                        <span>Disponible</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #dc3545;"></div>
                        <span>Ocupada</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffc107;"></div>
                        <span>Reservada</span>
                    </div>
                    
                </div>
            </div>
            <!-- Popup para reservaciones futuras (ahora dentro de main-content) -->
            
        </div>
    </div>

    <div id="popupMessage" class="popup-message"></div>



    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="popup-confirm" id="popupConfirm">
        <div id="popupConfirmMessage"></div>
        <div class="popup-confirm-buttons">
            <button class="popup-confirm-btn confirm" id="popupConfirmBtn">Confirmar</button>
            <button class="popup-confirm-btn cancel" id="popupCancelBtn">Cancelar</button>
        </div>
    </div>

    <!-- Modal para crear reservaci√≥n -->
    <div class="modal fade" id="modalReservacion" tabindex="-1" aria-labelledby="modalReservacionLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-gradient-primary text-black">
                    <h5 class="modal-title" id="modalReservacionLabel">
                        <i class="fas fa-calendar-plus me-2"></i>
                        Crear Nueva Reservaci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Pantalla 1: Informaci√≥n b√°sica -->
                    <div id="pantalla1" class="reservacion-pantalla">
                        <div class="p-4">
                            <div class="text-center mb-4">
                                <div class="reservacion-step active">
                                    <i class="fas fa-user-circle fa-2x text-primary mb-2"></i>
                                    <h6>Informaci√≥n del Cliente</h6>
                                </div>
                            </div>
                            <form id="formReservacion">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="nombreReservador" placeholder="Nombre completo" required>
                                            <label for="nombreReservador">
                                                <i class="fas fa-user me-2"></i>Nombre del Reservador
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="tel" class="form-control" id="telefonoReservador" placeholder="N√∫mero de celular">
                                            <label for="telefonoReservador">
                                                <i class="fas fa-phone me-2"></i>N√∫mero de Celular
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="number" class="form-control" id="cantidadPersonas" min="1" max="20" placeholder="Cantidad" required>
                                            <label for="cantidadPersonas">
                                                <i class="fas fa-users me-2"></i>Cantidad de Personas
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="date" class="form-control" id="fechaReservacion" placeholder="Fecha" required>
                                            <label for="fechaReservacion">
                                                <i class="fas fa-calendar me-2"></i>Fecha de Reservaci√≥n
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="time" class="form-control" id="horaReservacion" placeholder="Hora" required>
                                            <label for="horaReservacion">
                                                <i class="fas fa-clock me-2"></i>Hora de Reservaci√≥n
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="notaReservacion" placeholder="Notas adicionales" required></textarea>
                                            <label for="notaReservacion">
                                                <i class="fas fa-sticky-note me-2"></i>Ocasi√≥n
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <div class="row g-2" role="group">
                                                <div class="col-3">
                                                    <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="seleccionarOcasion('Cena')" title="Cena">
                                                        <i class="fas fa-utensils"></i>
                                                    </button>
                                                </div>
                                                <div class="col-3">
                                                    <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="seleccionarOcasion('Cumplea√±os')" title="Cumplea√±os">
                                                        <i class="fas fa-birthday-cake"></i>
                                                    </button>
                                                </div>
                                                <div class="col-3">
                                                    <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="seleccionarOcasion('Reuni√≥n de trabajo')" title="Reuni√≥n de trabajo">
                                                        <i class="fas fa-briefcase"></i>
                                                    </button>
                                                </div>
                                                <div class="col-3">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="activarInputOcasion()" title="Otro">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="siguientePantalla()">
                                <i class="fas fa-arrow-right me-2"></i>Siguiente
                            </button>
                        </div>
                    </div>

                    <!-- Pantalla 2: Selecci√≥n de √°rea y mesa -->
                    <div id="pantalla2" class="reservacion-pantalla" style="display: none;">
                        <div class="p-4">
                            <div class="text-center mb-4">
                                <div class="reservacion-step active">
                                    <i class="fas fa-map-marker-alt fa-2x text-primary mb-2"></i>
                                    <h6>Selecci√≥n de Ubicaci√≥n</h6>
                                </div>
                            </div>
                            <!-- Selecci√≥n de √°rea -->
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="fas fa-building me-2"></i>Selecciona el √Årea
                                </h6>
                                <div class="alert alert-info mb-3" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Filtro por fecha:</strong> Solo se mostrar√°n las mesas disponibles para el <span id="fechaFiltro" class="fw-bold"></span> que seleccionaste.
                                </div>
                                <div class="row g-3" id="areasContainer">
                                    <div class="col-md-4">
                                        <div class="area-option" data-area="interior" onclick="seleccionarArea('interior')">
                                            <div class="area-icon">
                                                <i class="fas fa-home"></i>
                                            </div>
                                            <h6>Interior</h6>
                                            <small class="text-muted">Ambiente climatizado</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="area-option" data-area="jardin" onclick="seleccionarArea('jardin')">
                                            <div class="area-icon">
                                                <i class="fas fa-leaf"></i>
                                            </div>
                                            <h6>Jard√≠n</h6>
                                            <small class="text-muted">Terraza al aire libre</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="area-option" data-area="reservados" onclick="seleccionarArea('reservados')">
                                            <div class="area-icon">
                                                <i class="fas fa-star"></i>
                                            </div>
                                            <h6>Reservados</h6>
                                            <small class="text-muted">√Årea exclusiva</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Layout de mesas -->
                            <div id="layoutMesas" style="display: none;">
                                <h6 class="mb-3">
                                    <i class="fas fa-table me-2"></i>Selecciona una Mesa Disponible
                                </h6>
                                <div id="mesasLayout" class="mesas-layout-container">
                                    <!-- Las mesas se cargar√°n din√°micamente aqu√≠ -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="anteriorPantalla()">
                                <i class="fas fa-arrow-left me-2"></i>Anterior
                            </button>
                            <button type="button" class="btn btn-primary" onclick="crearReservacion()" id="btnCrearReservacion" disabled>
                                <i class="fas fa-check me-2"></i>Crear Reservaci√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script>
        console.log('Cargando aplicaci√≥n de gesti√≥n de mesas - versi√≥n CON reservaciones - ' + new Date().toISOString());
        console.log('Stack trace para debugging:', new Error().stack);



        let mesaSeleccionada = null;
        let todasLasMesas = [];
        
        // Cache para optimizar consultas
        let cacheMesas = {
            data: null,
            timestamp: null,
            ttl: 30000 // 30 segundos
        };
        
        // Funci√≥n para verificar si el cache es v√°lido
        function isCacheValid() {
            return cacheMesas.data && 
                   cacheMesas.timestamp && 
                   (Date.now() - cacheMesas.timestamp) < cacheMesas.ttl;
        }
        
        // Funci√≥n para limpiar el cache
        function clearCache() {
            cacheMesas.data = null;
            cacheMesas.timestamp = null;
        }
        
        // Funciones de utilidad para manejo de zona horaria (GMT-7)
        let fechaActualCache = null;
        let fechaActualTimestamp = null;
        
        async function getCurrentDate() {
            // Cache por 1 minuto para evitar demasiadas llamadas al servidor
            const now = Date.now();
            if (fechaActualCache && fechaActualTimestamp && (now - fechaActualTimestamp) < 60000) {
                return fechaActualCache;
            }
            
            try {
                const response = await fetch('/api/fecha-actual');
                const data = await response.json();
                fechaActualCache = data.fecha;
                fechaActualTimestamp = now;
                return data.fecha;
            } catch (error) {
                console.error('Error al obtener fecha del servidor:', error);
                // Fallback a fecha local
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
        }
        
        function getCurrentTime() {
            const now = new Date();
            return now.toISOString().split('T')[1].substring(0, 5);
        }
        
        function formatTimeForDisplay(timeStr) {
            // Formatear hora para mostrar en formato 12 horas
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'pm' : 'am';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Funciones para manejar loading circles
        function mostrarLoadingArea(area) {
            const loadingElement = document.getElementById(`${area}Loading`);
            if (loadingElement) {
                loadingElement.style.display = 'flex';
            }
        }

        function ocultarLoadingArea(area) {
            const loadingElement = document.getElementById(`${area}Loading`);
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }

        function mostrarLoadingTodasLasAreas() {
            mostrarLoadingArea('interior');
            mostrarLoadingArea('jardin');
            mostrarLoadingArea('reservados');
        }

        function ocultarLoadingTodasLasAreas() {
            ocultarLoadingArea('interior');
            ocultarLoadingArea('jardin');
            ocultarLoadingArea('reservados');
        }


        




        function actualizarFechaHora() {
            const ahora = new Date();
            const fechaHoraActual = document.getElementById('fechaHoraActual');
            if (fechaHoraActual) {
                fechaHoraActual.textContent = ahora.toLocaleString('es-ES', {
                    dateStyle: 'full',
                    timeStyle: 'short'
                });
            }
        }

        async function limpiarReservacionesPasadas() {
            try {
                const response = await fetch('/api/actualizar-estado-mesas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // Si es 204 (No Content), no hay nada que hacer
                if (response.status === 204) {
                    return;
                }
                
                const resultado = await response.json();
                
                if (response.ok) {
                    mostrarMensaje(resultado.mensaje);
                    // Recargar las mesas despu√©s de la limpieza
                    cargarMesasSinGuardar();
                    cargarReservacionesSidebar();
                } else {
                    mostrarMensaje(`Error: ${resultado.error}`);
                }
            } catch (error) {
                console.error('Error al limpiar reservaciones:', error);
                // Solo mostrar error si no es un 204
                if (error.name !== 'TypeError' || !error.message.includes('JSON')) {
                    mostrarMensaje('Error al limpiar reservaciones pasadas');
                }
            }
        }

        // Funci√≥n para limpieza autom√°tica peri√≥dica (cada 30 minutos)
        function iniciarLimpiezaAutomatica() {
            setInterval(async () => {
                try {
                    const response = await fetch('/api/actualizar-estado-mesas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    // Si es 204 (No Content), no hay nada que hacer
                    if (response.status === 204) {
                        return;
                    }
                    
                    const resultado = await response.json();
                    
                    if (response.ok && (resultado.limpieza?.liberadas > 0 || resultado.actualizacion?.actualizadas > 0)) {
                        console.log(`Limpieza autom√°tica: ${resultado.mensaje}`);
                        // Recargar las mesas si se liberaron algunas o se actualizaron reservadas
                        cargarMesasSinGuardar();
                        cargarReservacionesSidebar();
                    }
                } catch (error) {
                    // Solo loggear errores reales, no los 204
                    if (error.name !== 'TypeError' || !error.message.includes('JSON')) {
                        console.error('Error en limpieza autom√°tica:', error);
                    }
                }
            }, 30 * 60 * 1000); // 30 minutos
        }

        document.addEventListener('DOMContentLoaded', function() {
            
            // Funci√≥n para actualizar fecha y hora en el header
            actualizarFechaHora();
            setInterval(actualizarFechaHora, 1000);
            
            
            // Cargar mesas iniciales
            cargarMesasSinGuardar();
            
            // Cargar reservaciones en el sidebar
            cargarReservacionesSidebar();
            
            // Iniciar limpieza autom√°tica de reservaciones pasadas
            iniciarLimpiezaAutomatica();
            
            // Ejecutar limpieza inicial al cargar la p√°gina
            limpiarReservacionesPasadas();

            // Verificar reservaciones activas cada minuto
            setInterval(verificarReservacionesActivas, 60000);
            
            // Verificar reservaciones activas inicialmente
            setTimeout(verificarReservacionesActivas, 2000);

            

            // cuando falten menos de 2 horas y a "ocupada" cuando llegue la hora
            
            



        });

        function mostrarMensaje(mensaje) {
            const popup = document.getElementById('popupMessage');
            popup.textContent = mensaje;
            popup.style.display = 'block';
            popup.style.animation = 'slideInRight 0.3s ease-out';
            
            setTimeout(() => {
                popup.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 500);
            }, 5000);
        }



        // Variables para manejar las vistas
        let vistaActual = 'enVivo';

        function mostrarVistaEnVivo() {
            vistaActual = 'enVivo';
            actualizarBotonesVista();
            cargarMesasSinGuardar();
            mostrarMensaje('Vista en vivo activada');
        }







        async function cargarMesasSinGuardar() {
            const fechaActual = await getCurrentDate();
            
            try {
                console.time('Carga de mesas optimizada');
                
                let mesas;
                
                // Verificar cache primero
                if (isCacheValid()) {
                    console.log('Usando cache de mesas');
                    mesas = cacheMesas.data;
                } else {
                    console.log('Cache expirado, consultando API');
                    // Mostrar loading circles para todas las √°reas
                    mostrarLoadingTodasLasAreas();
                    
                    // Una sola llamada para obtener todas las mesas con estados actualizados
                    const response = await fetch('/api/mesas');
                    mesas = await response.json();
                    
                    // Actualizar cache
                    cacheMesas.data = mesas;
                    cacheMesas.timestamp = Date.now();
                }
                
                todasLasMesas = mesas;
                
                // Limpiar layouts
                const interiorLayout = document.getElementById('interiorLayout');
                const jardinLayout = document.getElementById('jardinLayout');
                const reservadosLayout = document.getElementById('reservadosLayout');

                interiorLayout.innerHTML = '';
                jardinLayout.innerHTML = '';
                reservadosLayout.innerHTML = '';
                
                // Filtrar mesas para la vista "en vivo" (hoy):
                // 1. Mostrar SIEMPRE las mesas ocupadas
                // 2. Mostrar mesas reservadas SOLO si son para hoy
                // 3. Mostrar mesas disponibles (sin fecha o con fecha futura)
                const mesasFiltradas = mesas.filter(mesa => {
                    if (mesa.estado === 'ocupada') {
                        return true; // Siempre mostrar mesas ocupadas
                    }
                    if (mesa.estado === 'reservada') {
                        // Solo mostrar mesas reservadas si son para hoy
                        return mesa.fecha === fechaActual;
                    }
                    // Para mesas disponibles, mostrar si no tienen fecha o tienen fecha futura
                    return !mesa.fecha || mesa.fecha >= fechaActual;
                });

                // Ordenar las mesas por n√∫mero
                mesasFiltradas.sort((a, b) => a.numero - b.numero);

                // Agrupar mesas por √°rea
                const mesasPorArea = {
                    interior: mesasFiltradas.filter(m => m.ubicacion === 'interior'),
                    jardin: mesasFiltradas.filter(m => m.ubicacion === 'jardin'),
                    reservados: mesasFiltradas.filter(m => m.ubicacion === 'reservados')
                };

                // Reorganizar mesas verticalmente por √°rea
                const mesasReorganizadas = {
                    interior: reorganizarMesasVertical(mesasPorArea.interior, 'interior'),
                    jardin: reorganizarMesasVertical(mesasPorArea.jardin, 'jardin'),
                    reservados: reorganizarMesasVertical(mesasPorArea.reservados, 'reservados')
                };

                // Crear elementos de mesa de forma optimizada
                const elementosMesas = await Promise.all(
                    mesasFiltradas.map(mesa => crearElementoMesa(mesa))
                );

                // Agrupar elementos por √°rea para inserci√≥n eficiente
                const elementosPorArea = {
                    interior: [],
                    jardin: [],
                    reservados: []
                };

                // Crear un mapa de elementos por ID de mesa para acceso r√°pido
                const elementosPorMesaId = {};
                elementosMesas.forEach((elemento, index) => {
                    const mesa = mesasFiltradas[index];
                    elementosPorMesaId[mesa.id] = elemento;
                });

                // Organizar elementos seg√∫n el orden reorganizado
                mesasReorganizadas.interior.forEach(mesa => {
                    elementosPorArea.interior.push(elementosPorMesaId[mesa.id]);
                });
                mesasReorganizadas.jardin.forEach(mesa => {
                    elementosPorArea.jardin.push(elementosPorMesaId[mesa.id]);
                });
                mesasReorganizadas.reservados.forEach(mesa => {
                    elementosPorArea.reservados.push(elementosPorMesaId[mesa.id]);
                });

                // Insertar elementos en sus respectivos layouts
                if (elementosPorArea.interior.length > 0) {
                    interiorLayout.append(...elementosPorArea.interior);
                }
                if (elementosPorArea.jardin.length > 0) {
                    jardinLayout.append(...elementosPorArea.jardin);
                }
                if (elementosPorArea.reservados.length > 0) {
                    reservadosLayout.append(...elementosPorArea.reservados);
                }

                console.timeEnd('Carga de mesas optimizada');
                
                // Ocultar loading circles
                ocultarLoadingTodasLasAreas();
                
                // Actualizar la fecha y hora en el header
                actualizarFechaHora();
                
                // Cargar reservaciones en el sidebar
                cargarReservacionesSidebar();

            } catch (error) {
                console.error('Error al cargar mesas:', error);
                // Ocultar loading circles en caso de error
                ocultarLoadingTodasLasAreas();
                
                let mensaje = 'Error al cargar las mesas';
                if (error && error.message) {
                    mensaje += ': ' + error.message;
                } else if (typeof error === 'string') {
                    mensaje += ': ' + error;
                }
                mostrarMensaje(mensaje);
            }
        }

        async function cargarReservacionesSidebar() {
            try {
                const fechaActual = await getCurrentDate();
                
                // Mostrar loading en el sidebar
                const sidebarContainer = document.getElementById('sidebarReservaciones');
                sidebarContainer.innerHTML = '<div class="no-reservaciones">Cargando reservaciones...</div>';
                
                const response = await fetch(`/api/reservaciones?fecha=${fechaActual}`);
                const reservaciones = await response.json();
                
                // Guardar todas las reservaciones en la variable global
                todasLasReservaciones = reservaciones;
                
                // Mostrar todas las reservaciones inicialmente
                mostrarReservacionesEnSidebar(reservaciones);
                
            } catch (error) {
                console.error('Error al cargar reservaciones:', error);
                const sidebarContainer = document.getElementById('sidebarReservaciones');
                sidebarContainer.innerHTML = '<div class="no-reservaciones">Error al cargar reservaciones</div>';
            }
        }

        function esReservacionProxima(horaReservacion) {
            const ahora = new Date();
            const [hora, minutos] = horaReservacion.split(':');
            const horaReservacionDate = new Date();
            horaReservacionDate.setHours(parseInt(hora), parseInt(minutos), 0, 0);
            
            const diferencia = horaReservacionDate - ahora;
            const dosHoras = 2 * 60 * 60 * 1000; // 2 horas en milisegundos
            
            return diferencia > 0 && diferencia <= dosHoras;
        }

        function esReservacionPasada(horaReservacion) {
            const ahora = new Date();
            const [hora, minutos] = horaReservacion.split(':');
            const horaReservacionDate = new Date();
            horaReservacionDate.setHours(parseInt(hora), parseInt(minutos), 0, 0);
            
            return horaReservacionDate < ahora;
        }

        function obtenerIconoArea(area) {
            switch(area.toLowerCase()) {
                case 'interior':
                    return 'fa-home';
                case 'jardin':
                    return 'fa-leaf';
                case 'reservados':
                    return 'fa-star';
                default:
                    return 'fa-map-marker-alt';
            }
        }

        function capitalizarPrimeraLetra(texto) {
            return texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase();
        }

        let todasLasReservaciones = []; // Variable global para almacenar todas las reservaciones

        async function filtrarReservacionesPorArea() {
            const areaSeleccionada = document.getElementById('filtroArea').value;
            const sidebarContainer = document.getElementById('sidebarReservaciones');
            
            if (areaSeleccionada === 'todas') {
                // Mostrar todas las reservaciones
                mostrarReservacionesEnSidebar(todasLasReservaciones);
            } else {
                // Filtrar por √°rea espec√≠fica
                const reservacionesFiltradas = todasLasReservaciones.filter(reservacion => 
                    reservacion.area === areaSeleccionada
                );
                mostrarReservacionesEnSidebar(reservacionesFiltradas);
            }
        }

        function mostrarReservacionesEnSidebar(reservaciones) {
            const sidebarContainer = document.getElementById('sidebarReservaciones');
            
            if (reservaciones.length === 0) {
                sidebarContainer.innerHTML = '<div class="no-reservaciones">No hay reservaciones para el √°rea seleccionada</div>';
                return;
            }
            
            // Ordenar reservaciones por hora
            reservaciones.sort((a, b) => {
                const horaA = a.hora_reservacion;
                const horaB = b.hora_reservacion;
                return horaA.localeCompare(horaB);
            });
            
            let reservacionesHTML = '';
            
            for (const reservacion of reservaciones) {
                const horaFormateada = formatTimeForDisplay(reservacion.hora_reservacion);
                const esProxima = esReservacionProxima(reservacion.hora_reservacion);
                const esPasada = esReservacionPasada(reservacion.hora_reservacion);
                
                let claseReservacion = 'reservacion-item';
                if (esProxima) claseReservacion += ' reservacion-proxima';
                if (esPasada) claseReservacion += ' reservacion-pasada';
                
                // Determinar el tipo de bot√≥n de liberar
                let tipoBoton = 'normal';
                if (esProxima) tipoBoton = 'proxima';
                if (esPasada) tipoBoton = 'activa'; // Reservaciones pasadas (ya es hora) = activas
                
                reservacionesHTML += `
                    <div class="${claseReservacion}" onclick="mostrarDetallesReservacion(${reservacion.id})">
                        <button class="btn-liberar-reservacion ${tipoBoton}" 
                                onclick="event.stopPropagation(); liberarReservacion(${reservacion.id}, '${reservacion.nombre_reservador}')" 
                                title="Liberar reservaci√≥n">
                            <i class="fas fa-door-open"></i>
                        </button>
                        <div class="reservacion-hora">${horaFormateada}</div>
                        <div class="reservacion-nombre">${reservacion.nombre_reservador}</div>
                        <div class="reservacion-detalles">
                            <div class="reservacion-detalle">
                                <i class="fas fa-table"></i>
                                <span><img src="/static/images/table.svg" alt="mesa" class="mesa-icon-small"> ${reservacion.mesa_numero} ‚Ä¢ <i class="fas ${obtenerIconoArea(reservacion.area)}"></i> ${capitalizarPrimeraLetra(reservacion.area)}</span>
                            </div>
                            <div class="reservacion-detalle">
                                <i class="fas fa-users"></i>
                                <span class="reservacion-personas">${reservacion.cantidad_personas} personas</span>
                            </div>
                            ${reservacion.telefono ? `
                            <div class="reservacion-detalle">
                                <i class="fas fa-phone"></i>
                                <span class="reservacion-telefono">${reservacion.telefono}</span>
                            </div>
                            ` : ''}
                            ${reservacion.nota ? `
                            <div class="reservacion-detalle">
                                <i class="fas fa-sticky-note"></i>
                                <span class="reservacion-nota">${reservacion.nota}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            sidebarContainer.innerHTML = reservacionesHTML;
        }

        function mostrarDetallesReservacion(reservacionId) {
            // Funci√≥n vac√≠a - no hacer nada al hacer clic
        }

        async function liberarReservacion(reservacionId, nombreReservador) {
            // Mostrar confirmaci√≥n antes de liberar
            mostrarConfirmacion(`¬øEst√°s seguro de que deseas liberar la reservaci√≥n de ${nombreReservador}?`, async (confirmado) => {
                if (confirmado) {
                    try {
                        // Limpiar cache antes de la operaci√≥n
                        clearCache();
                        
                        const response = await fetch(`/api/reservaciones/${reservacionId}/liberar`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            mostrarMensaje('Reservaci√≥n liberada exitosamente');
                            // Recargar mesas y reservaciones
                            cargarMesasSinGuardar();
                            cargarReservacionesSidebar();
                        } else {
                            mostrarMensaje(`Error: ${result.error}`);
                        }
                    } catch (error) {
                        console.error('Error al liberar reservaci√≥n:', error);
                        mostrarMensaje('Error al liberar la reservaci√≥n');
                    }
                }
            });
        }

        async function mostrarFormularioReservacion() {
            try {
                // Obtener la fecha actual desde el backend (zona horaria del restaurante)
                const response = await fetch('/api/fecha-actual');
                const data = await response.json();
                const today = data.fecha;
                
                // Establecer fecha m√≠nima como hoy
                document.getElementById('fechaReservacion').min = today;
                document.getElementById('fechaReservacion').value = today;
                
                // Establecer hora por defecto (7:00 PM)
                document.getElementById('horaReservacion').value = '19:00';
                
                // Limpiar formulario
                document.getElementById('formReservacion').reset();
                document.getElementById('fechaReservacion').value = today;
                document.getElementById('horaReservacion').value = '19:00';
                document.getElementById('areaReservacion').value = '';
                document.getElementById('mesaReservacion').innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
                document.getElementById('infoMesa').style.display = 'none';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalReservacion'));
                modal.show();
            } catch (error) {
                console.error('Error al obtener fecha actual:', error);
                // Fallback a fecha local si hay error
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fechaReservacion').min = today;
                document.getElementById('fechaReservacion').value = today;
                document.getElementById('horaReservacion').value = '19:00';
                
                const modal = new bootstrap.Modal(document.getElementById('modalReservacion'));
                modal.show();
            }
        }

        function reorganizarMesasVertical(mesas, area) {
            if (area === 'interior') {
                // Orden espec√≠fico para interior:
                // Columna 1: Mesa 101, 102, 103, 104, 105
                // Columna 2: Mesa 106, 107, 108, 109
                // Columna 3: Mesa 201, 202, 203
                // Columna 4: Mesa 204, 205, 206
                const ordenEspecifico = [101, 102, 103, 104, 105, 106, 107, 108, 109, 201, 202, 203, 204, 205, 206];
                return ordenarPorSecuencia(mesas, ordenEspecifico);
            } else if (area === 'jardin') {
                // Orden espec√≠fico para jard√≠n:
                // Columna 1: Mesa 301, 302, 303
                // Columna 2: Mesa 304, 305, 306
                // Columna 3: Mesa 401, 402, 403
                // Columna 4: Mesa 404, 405, 406
                const ordenEspecifico = [301, 302, 303, 304, 305, 306, 401, 402, 403, 404, 405, 406];
                return ordenarPorSecuencia(mesas, ordenEspecifico);
            } else if (area === 'reservados') {
                // Mantener orden original para reservados
                return mesas;
            }
            
            return mesas;
        }
        
        function ordenarPorSecuencia(mesas, secuencia) {
            const mesasOrdenadas = [];
            const mesasMap = new Map();
            
            // Crear un mapa de mesas por n√∫mero
            mesas.forEach(mesa => {
                mesasMap.set(mesa.numero, mesa);
            });
            
            // Ordenar seg√∫n la secuencia especificada
            secuencia.forEach(numero => {
                if (mesasMap.has(numero)) {
                    mesasOrdenadas.push(mesasMap.get(numero));
                }
            });
            
            return mesasOrdenadas;
        }

        async function cargarMesasPorArea(area) {
            try {
                console.time(`Carga √°rea ${area}`);
                
                // Mostrar loading circle para el √°rea espec√≠fica
                mostrarLoadingArea(area);
                
                // Usar la API optimizada para el √°rea espec√≠fica
                const response = await fetch(`/api/mesas/area/${area}`);
                const mesasArea = await response.json();
                
                const fechaActual = getCurrentDate();
                
                // Actualizar solo las mesas de esta √°rea en todasLasMesas
                todasLasMesas = todasLasMesas.filter(mesa => mesa.ubicacion !== area);
                todasLasMesas.push(...mesasArea);
                
                // Filtrar mesas del √°rea espec√≠fica para mostrar
                const mesasParaMostrar = mesasArea.filter(mesa => {
                    if (mesa.estado === 'ocupada') {
                        return true; // Siempre mostrar mesas ocupadas
                    }
                    if (mesa.estado === 'reservada') {
                        // Solo mostrar mesas reservadas si son para hoy
                        return mesa.fecha === fechaActual;
                    }
                    // Para mesas disponibles, mostrar si no tienen fecha o tienen fecha futura
                    return !mesa.fecha || mesa.fecha >= fechaActual;
                });
                
                // Ordenar las mesas por n√∫mero
                mesasParaMostrar.sort((a, b) => a.numero - b.numero);
                
                // Reorganizar mesas para llenado vertical
                mesasParaMostrar = reorganizarMesasVertical(mesasParaMostrar, area);
                
                // Obtener el contenedor del √°rea
                let areaLayout;
                if (area === 'interior') {
                    areaLayout = document.getElementById('interiorLayout');
                } else if (area === 'jardin') {
                    areaLayout = document.getElementById('jardinLayout');
                } else if (area === 'reservados') {
                    areaLayout = document.getElementById('reservadosLayout');
                }
                
                if (areaLayout) {
                    // Limpiar el √°rea
                    areaLayout.innerHTML = '';
                    
                    // Crear elementos de mesa de forma optimizada
                    const elementosMesas = await Promise.all(
                        mesasParaMostrar.map(mesa => crearElementoMesa(mesa))
                    );
                    
                    // Insertar todos los elementos de una vez
                    if (elementosMesas.length > 0) {
                        areaLayout.append(...elementosMesas);
                    }
                }
                
                console.timeEnd(`Carga √°rea ${area}`);
                
            } catch (error) {
                console.error(`Error al cargar mesas del √°rea ${area}:`, error);
                mostrarMensaje(`Error al cargar mesas del √°rea ${area}`);
            } finally {
                // Ocultar loading circle para el √°rea espec√≠fica
                ocultarLoadingArea(area);
            }
        }

        function mostrarInfoMesa() {
            const selectMesa = document.getElementById('mesaReservacion');
            const mesaSeleccionada = selectMesa.options[selectMesa.selectedIndex];
            
            if (mesaSeleccionada.value) {
                const numero = mesaSeleccionada.getAttribute('data-numero');
                const capacidad = mesaSeleccionada.getAttribute('data-capacidad');
                
                document.getElementById('numeroMesa').textContent = numero;
                document.getElementById('capacidadMesa').textContent = capacidad;
                document.getElementById('estadoMesa').textContent = 'Disponible';
                document.getElementById('infoMesa').style.display = 'block';
            } else {
                document.getElementById('infoMesa').style.display = 'none';
            }
        }

        async function crearReservacion() {
            // Validar que haya mesa seleccionada
            if (!reservacionMesaSeleccionada || !reservacionAreaSeleccionada) {
                mostrarMensaje('Selecciona un √°rea y una mesa');
                return;
            }
            // Validar formulario
            const form = document.getElementById('formReservacion');
            if (!form.checkValidity()) {
                mostrarMensaje('Completa los datos de la reservaci√≥n');
                anteriorPantalla();
                return;
            }
            
            // Deshabilitar bot√≥n
            const btnCrear = document.getElementById('btnCrearReservacion');
            btnCrear.disabled = true;
            
            const formData = {
                nombre_reservador: document.getElementById('nombreReservador').value,
                telefono: document.getElementById('telefonoReservador').value,
                cantidad_personas: parseInt(document.getElementById('cantidadPersonas').value),
                fecha_reservacion: document.getElementById('fechaReservacion').value,
                hora_reservacion: document.getElementById('horaReservacion').value,
                nota: document.getElementById('notaReservacion').value,
                area: reservacionAreaSeleccionada,
                mesa_id: reservacionMesaSeleccionada
            };
            try {
                const response = await fetch('/api/reservaciones', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                if (response.ok) {
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalReservacion'));
                    modal.hide();
                    mostrarMensaje('Reservaci√≥n creada exitosamente');
                    // Limpiar cache para forzar actualizaci√≥n
                    clearCache();
                    // Actualizar inmediatamente la mesa espec√≠fica a estado "reservada"
                    await actualizarMesaEspecifica(reservacionMesaSeleccionada, 'reservada');
                    // Verificar si la reservaci√≥n debe mostrar punto naranja (si la hora ya lleg√≥)
                    setTimeout(() => {
                        verificarReservacionesActivas();
                    }, 500);
                    // Recargar reservaciones en el sidebar
                    cargarReservacionesSidebar();
                } else {
                    mostrarMensaje(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error al crear la reservaci√≥n:', error);
                mostrarMensaje('Error al crear la reservaci√≥n');
            } finally {
                // Habilitar bot√≥n
                btnCrear.disabled = false;
            }
        }

        async function crearElementoMesa(mesa) {
            const mesaElement = document.createElement('div');
            mesaElement.className = `mesa ${mesa.estado}`;
            mesaElement.setAttribute('data-mesa-id', mesa.id);
            
            // Aplicar posicionamiento CSS espec√≠fico seg√∫n el √°rea
            if (mesa.ubicacion === 'interior') {
                mesaElement.style.gridColumn = mesa.posicion_x;
                mesaElement.style.gridRow = mesa.posicion_y;
            } else if (mesa.ubicacion === 'jardin') {
                mesaElement.style.gridColumn = mesa.posicion_x;
                mesaElement.style.gridRow = mesa.posicion_y;
            } else if (mesa.ubicacion === 'reservados') {
                mesaElement.style.gridColumn = mesa.posicion_x;
                mesaElement.style.gridRow = mesa.posicion_y;
            }
            
            let capacidadTexto = mesa.capacidad === 0 ? 'Sin l√≠mite' : mesa.capacidad + ' m√°x.';
            let mesaInfo = `
                <div class="mesa-info">
                    <div class="mesa-numero"><img src="/static/images/table.svg" alt="mesa" class="mesa-icon"> ${mesa.numero}</div>
                    <div class="mesa-capacidad">${capacidadTexto}</div>
                </div>
            `;
            
            mesaElement.innerHTML = mesaInfo;
            
            // Agregar tooltip para mesas reservadas
            if (mesa.estado === 'reservada') {
                await agregarTooltipReservacion(mesaElement, mesa.id);
            }
            
            // Verificar si la mesa tiene reservaciones activas
            try {
                const response = await fetch(`/api/reservaciones/mesa/${mesa.id}`);
                const reservaciones = await response.json();
                
                // Filtrar reservaciones para hoy
                const fechaActual = getCurrentDate();
                const reservacionesHoy = reservaciones.filter(r => r.fecha_reservacion === fechaActual);
                
                // Verificar si hay reservaciones activas (hora ya lleg√≥)
                const reservacionesActivas = reservacionesHoy.filter(r => {
                    return esReservacionPasada(r.hora_reservacion);
                });
                
                // Si hay reservaciones activas, a√±adir el √≠cono naranja
                if (reservacionesActivas.length > 0) {
                    const iconoActivo = document.createElement('div');
                    iconoActivo.className = 'mesa-icono-activo';
                    iconoActivo.style.cssText = `
                        position: absolute;
                        top: 6px;
                        right: 6px;
                        width: 18px;
                        height: 18px;
                        background: #FF9800;
                        border-radius: 50%;
                        opacity: 0.8;
                        animation: pulse-orange 2s infinite;
                        box-shadow: 0 0 12px rgba(255, 152, 0, 0.6);
                        z-index: 10;
                    `;
                    mesaElement.appendChild(iconoActivo);
                }
                

            } catch (error) {
                console.error('Error al verificar reservaciones de la mesa:', error);
            }
            
            // Verificar si la mesa est√° ocupada temporalmente (desde localStorage)
            if (mesa.estado === 'reservada') {
                const mesasOcupadasTemp = JSON.parse(localStorage.getItem('mesasOcupadasTemp') || '[]');
                if (mesasOcupadasTemp.includes(mesa.id)) {
                    mesaElement.classList.add('ocupada-temporaria');
                }
            }
            
            mesaElement.onclick = () => {
                if (mesa.estado === 'disponible') {
                    // Crear opciones
                    const opciones = document.createElement('div');
                    opciones.className = 'mesa-opciones';
                    
                    let opcionesHTML = `
                        <div class="mesa-opcion ocupar" onclick="event.stopPropagation(); ocuparMesa(${mesa.id})">
                            <i class="fas fa-user-check"></i> Ocupar
                        </div>
                    `;
                    
                    opciones.innerHTML = opcionesHTML;
                    
                    // Remover opciones existentes
                    const opcionesExistentes = mesaElement.querySelector('.mesa-opciones');
                    if (opcionesExistentes) {
                        opcionesExistentes.remove();
                    }
                    
                    mesaElement.appendChild(opciones);
                    
                    // Cerrar opciones al hacer clic fuera
                    const cerrarOpciones = (e) => {
                        if (!mesaElement.contains(e.target)) {
                            opciones.remove();
                            document.removeEventListener('click', cerrarOpciones);
                        }
                    };
                    setTimeout(() => {
                        document.addEventListener('click', cerrarOpciones);
                    }, 0);
                } else if (mesa.estado === 'reservada') {
                    // Crear opciones para mesa reservada
                    const opciones = document.createElement('div');
                    opciones.className = 'mesa-opciones';
                    
                    // Verificar si ya est√° ocupada temporalmente
                    const estaOcupadaTemporalmente = mesaElement.classList.contains('ocupada-temporaria');
                    
                    let opcionesHTML = '';
                    if (estaOcupadaTemporalmente) {
                        opcionesHTML = `
                            <div class="mesa-opcion liberar-temp" onclick="event.stopPropagation(); liberarMesaTemporal(${mesa.id})">
                                <i class="fas fa-times"></i> Liberar
                            </div>
                        `;
                    } else {
                        opcionesHTML = `
                            <div class="mesa-opcion ocupar-temp" onclick="event.stopPropagation(); ocuparMesaTemporal(${mesa.id})">
                                <i class="fas fa-user-check"></i> Ocupar temporalmente
                            </div>
                        `;
                    }
                    
                    opciones.innerHTML = opcionesHTML;
                    
                    // Remover opciones existentes
                    const opcionesExistentes = mesaElement.querySelector('.mesa-opciones');
                    if (opcionesExistentes) {
                        opcionesExistentes.remove();
                    }
                    
                    mesaElement.appendChild(opciones);
                    
                    // Cerrar opciones al hacer clic fuera
                    const cerrarOpciones = (e) => {
                        if (!mesaElement.contains(e.target)) {
                            opciones.remove();
                            document.removeEventListener('click', cerrarOpciones);
                        }
                    };
                    setTimeout(() => {
                        document.addEventListener('click', cerrarOpciones);
                    }, 0);
                }
            };

            // A√±adir bot√≥n de liberar para mesas ocupadas
            if (mesa.estado === 'ocupada') {
                const btnLiberar = document.createElement('button');
                btnLiberar.className = 'btn-liberar';
                btnLiberar.innerHTML = '<i class="fas fa-door-open"></i>';
                btnLiberar.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    liberarMesa(mesa.id);
                };
                mesaElement.appendChild(btnLiberar);
            }

            return mesaElement;
        }

        function actualizarVisualizacionMesasUnidas() {
            // Actualizar todas las √°reas para mostrar las mesas unidas
            cargarMesasPorArea('interior');
            cargarMesasPorArea('jardin');
            cargarMesasPorArea('reservados');
        }

        function actualizarMesaConAnimacion(mesaId, nuevaClase) {
            const mesaElement = document.querySelector(`[data-mesa-id="${mesaId}"]`);
            if (mesaElement) {
                mesaElement.className = `mesa ${nuevaClase}`;
            }
        }

        function ocuparMesa(mesaId) {
            const fechaActual = getCurrentDate();
            
            // Obtener la mesa para saber su √°rea
            const mesa = todasLasMesas.find(m => m.id === mesaId);
            if (!mesa) {
                mostrarMensaje('Error: Mesa no encontrada');
                return;
            }
            
            // Limpiar cache antes de la operaci√≥n
            clearCache();
            
            fetch(`/api/mesas/${mesaId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    estado: 'ocupada',
                    fecha: fechaActual
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al actualizar la mesa');
                }
                return response.json();
            })
            .then(() => {
                // Actualizar solo la mesa espec√≠fica (optimizado)
                actualizarMesaEspecifica(mesaId, 'ocupada', fechaActual);
                mostrarMensaje('Mesa marcada como ocupada');
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error al ocupar la mesa');
            });
        }

        function liberarMesa(mesaId) {
            // Obtener la mesa para saber su √°rea
            const mesa = todasLasMesas.find(m => m.id === mesaId);
            if (!mesa) {
                mostrarMensaje('Error: Mesa no encontrada');
                return;
            }
            
            mostrarConfirmacion('¬øEst√°s seguro de que deseas liberar esta mesa?', (confirmado) => {
                if (confirmado) {
                    // Limpiar cache antes de la operaci√≥n
                    clearCache();
                    
                    fetch(`/api/mesas/${mesaId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            estado: 'disponible',
                            fecha: null
                        })
                    })
                    .then(() => {
                        // Actualizar solo la mesa espec√≠fica (optimizado)
                        actualizarMesaEspecifica(mesaId, 'disponible', null);
                        mostrarMensaje('Mesa liberada correctamente');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarMensaje('Error al liberar la mesa');
                    });
                }
            });
        }



        function cambiarEstadoMesa(mesaId, estadoActual) {
            const estados = ['disponible', 'ocupada'];
            const nuevoEstado = estados[(estados.indexOf(estadoActual) + 1) % estados.length];
            
            fetch(`/api/mesas/${mesaId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ estado: nuevoEstado })
            })
            .then(response => response.json())
            .then(() => cargarMesasSinGuardar());
        }







        function mostrarConfirmacion(mensaje, callback) {
            const popup = document.getElementById('popupConfirm');
            const overlay = document.getElementById('popupOverlay');
            const message = document.getElementById('popupConfirmMessage');
            const confirmBtn = document.getElementById('popupConfirmBtn');
            const cancelBtn = document.getElementById('popupCancelBtn');
            
            message.textContent = mensaje;
            popup.style.display = 'block';
            overlay.style.display = 'block';
            
            const handleConfirm = () => {
                popup.style.display = 'none';
                overlay.style.display = 'none';
                callback(true);
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            const handleCancel = () => {
                popup.style.display = 'none';
                overlay.style.display = 'none';
                callback(false);
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }



        // --- FLUJO MODAL RESERVACI√ìN MODERNO ---
        let reservacionAreaSeleccionada = null;
        let reservacionMesaSeleccionada = null;
        let mesasDisponiblesModal = [];


        async function mostrarFormularioReservacion() {
            // Pantalla 1 visible, pantalla 2 oculta
            document.getElementById('pantalla1').style.display = '';
            document.getElementById('pantalla2').style.display = 'none';
            reservacionAreaSeleccionada = null;
            reservacionMesaSeleccionada = null;
            document.getElementById('btnCrearReservacion').disabled = true;
            // Limpiar selecci√≥n de √°reas
            document.querySelectorAll('.area-option').forEach(opt => opt.classList.remove('selected'));
            // Limpiar layout mesas
            document.getElementById('layoutMesas').style.display = 'none';
            document.getElementById('mesasLayout').innerHTML = '';
            // Limpiar formulario
            const today = await getCurrentDate(); // Usar la fecha del servidor con zona horaria correcta
            document.getElementById('formReservacion').reset();
            document.getElementById('fechaReservacion').min = today;
            document.getElementById('fechaReservacion').value = today;
            document.getElementById('horaReservacion').value = '19:00';
            
            // Agregar event listener para el cambio de fecha
            const fechaInput = document.getElementById('fechaReservacion');
            fechaInput.removeEventListener('change', onFechaReservacionChange);
            fechaInput.addEventListener('change', onFechaReservacionChange);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalReservacion'));
            modal.show();
        }

        function siguientePantalla() {
            const form = document.getElementById('formReservacion');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Actualizar el mensaje de fecha en la pantalla 2
            const fechaSeleccionada = document.getElementById('fechaReservacion').value;
            const fechaFiltro = document.getElementById('fechaFiltro');
            if (fechaFiltro && fechaSeleccionada) {
                // Formatear la fecha para mostrar correctamente
                const [year, month, day] = fechaSeleccionada.split('-');
                const fecha = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const fechaFormateada = fecha.toLocaleDateString('es-ES', opciones);
                fechaFiltro.textContent = fechaFormateada;
            }
            
            document.getElementById('pantalla1').style.display = 'none';
            document.getElementById('pantalla2').style.display = '';
        }

        function anteriorPantalla() {
            document.getElementById('pantalla2').style.display = 'none';
            document.getElementById('pantalla1').style.display = '';
        }

        function seleccionarArea(area) {
            reservacionAreaSeleccionada = area;
            reservacionMesaSeleccionada = null;
            document.getElementById('btnCrearReservacion').disabled = true;
            // Marcar √°rea seleccionada
            document.querySelectorAll('.area-option').forEach(opt => {
                if (opt.getAttribute('data-area') === area) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            // Cargar mesas disponibles para el √°rea
            cargarMesasModalPorArea(area);
        }

        // Funci√≥n que se ejecuta cuando cambia la fecha de reservaci√≥n
        function onFechaReservacionChange() {
            // Actualizar el mensaje de fecha si estamos en la pantalla 2
            const fechaSeleccionada = document.getElementById('fechaReservacion').value;
            const fechaFiltro = document.getElementById('fechaFiltro');
            if (fechaFiltro && fechaSeleccionada) {
                // Formatear la fecha para mostrar correctamente
                const [year, month, day] = fechaSeleccionada.split('-');
                const fecha = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const fechaFormateada = fecha.toLocaleDateString('es-ES', opciones);
                fechaFiltro.textContent = fechaFormateada;
            }
            
            // Si ya hay un √°rea seleccionada, recargar las mesas con la nueva fecha
            if (reservacionAreaSeleccionada) {
                cargarMesasModalPorArea(reservacionAreaSeleccionada);
            }
        }

        // Funci√≥n para verificar si una mesa est√° disponible en una fecha espec√≠fica
        async function verificarDisponibilidadMesa(mesaId, fecha) {
            try {
                const response = await fetch(`/api/reservaciones/mesa/${mesaId}`);
                const reservaciones = await response.json();
                
                // Filtrar reservaciones para la fecha espec√≠fica
                const reservacionesEnFecha = reservaciones.filter(r => r.fecha_reservacion === fecha);
                
                // Si no hay reservaciones en esa fecha, la mesa est√° disponible
                return reservacionesEnFecha.length === 0;
            } catch (error) {
                console.error('Error al verificar disponibilidad de mesa:', error);
                return false; // En caso de error, asumir que no est√° disponible
            }
        }

        async function cargarMesasModalPorArea(area) {
            try {
                console.time(`Carga modal √°rea ${area}`);
                
                // Obtener la fecha seleccionada
                const fechaSeleccionada = document.getElementById('fechaReservacion').value;
                if (!fechaSeleccionada) {
                    console.error('No se ha seleccionado una fecha');
                    return;
                }
                
                // Limpiar el layout de mesas
                const mesasLayout = document.getElementById('mesasLayout');
                mesasLayout.innerHTML = '<div class="text-center" style="width: 100%; text-align: center; white-space: nowrap;"><i class="fas fa-spinner fa-spin me-2"></i>Verificando disponibilidad para ' + fechaSeleccionada + '...</div>';
                
                // Usar la API optimizada
                const response = await fetch(`/api/mesas/area/${area}`);
                const mesas = await response.json();
                
                // Filtrar mesas: mostrar TODAS excepto las que tienen reservaciones en la fecha seleccionada
                const mesasDisponibles = [];
                
                for (const mesa of mesas) {
                    // Verificar si no tiene reservaciones en la fecha seleccionada
                    const estaDisponible = await verificarDisponibilidadMesa(mesa.id, fechaSeleccionada);
                    if (estaDisponible) {
                        mesasDisponibles.push(mesa);
                    }
                }
                
                mesasDisponiblesModal = mesasDisponibles;
                renderMesasLayoutModal(area, mesasDisponibles);
                
                console.timeEnd(`Carga modal √°rea ${area}`);
            } catch (error) {
                console.error('Error al cargar mesas para modal:', error);
                document.getElementById('layoutMesas').style.display = 'block';
                document.getElementById('mesasLayout').innerHTML = '<div class="text-danger">Error al cargar mesas</div>';
            }
        }

        function renderMesasLayoutModal(area, mesas) {
            const layout = document.getElementById('mesasLayout');
            layout.className = 'mesas-layout-container ' + area;
            layout.innerHTML = '';
            
            // Las mesas ya vienen filtradas por disponibilidad en la fecha seleccionada
            if (mesas.length === 0) {
                document.getElementById('layoutMesas').style.display = 'block';
                const fechaSeleccionada = document.getElementById('fechaReservacion').value;
                layout.innerHTML = `<div class="text-warning">No hay mesas disponibles en esta √°rea para el ${fechaSeleccionada}</div>`;
                return;
            }
            
            mesas.forEach(mesa => {
                const div = document.createElement('div');
                div.className = 'mesa-modal disponible';
                div.tabIndex = 0;
                let capacidadTexto = mesa.capacidad === 0 ? 'Sin l√≠mite' : mesa.capacidad + ' pers. m√°x.';
                div.innerHTML = `<div class='mesa-numero'><img src="/static/images/table.svg" alt="mesa" class="mesa-icon"> ${mesa.numero}</div><div class='mesa-capacidad'>${capacidadTexto}</div>`;
                div.onclick = () => seleccionarMesaModal(mesa.id);
                if (reservacionMesaSeleccionada === mesa.id) {
                    div.classList.add('selected');
                }
                layout.appendChild(div);
            });
            document.getElementById('layoutMesas').style.display = 'block';
        }

        function seleccionarMesaModal(mesaId) {
            reservacionMesaSeleccionada = mesaId;
            // Marcar mesa seleccionada
            document.querySelectorAll('.mesa-modal').forEach(div => div.classList.remove('selected'));
            const mesas = document.querySelectorAll('.mesa-modal');
            for (let i = 0; i < mesas.length; i++) {
                if (mesasDisponiblesModal[i].id === mesaId) {
                    mesas[i].classList.add('selected');
                }
            }
            document.getElementById('btnCrearReservacion').disabled = false;
        }

        // Funci√≥n para verificar y actualizar el estado de reservaciones activas en todas las mesas
        async function verificarReservacionesActivas() {
            try {
                console.log('Verificando reservaciones activas...');
                
                // Obtener todas las mesas que est√°n reservadas o disponibles
                const mesasParaVerificar = todasLasMesas.filter(mesa => 
                    mesa.estado === 'reservada' || mesa.estado === 'disponible'
                );
                
                for (const mesa of mesasParaVerificar) {
                    try {
                        const response = await fetch(`/api/reservaciones/mesa/${mesa.id}`);
                        const reservaciones = await response.json();
                        
                        // Filtrar reservaciones para hoy
                        const fechaActual = await getCurrentDate();
                        const reservacionesHoy = reservaciones.filter(r => r.fecha_reservacion === fechaActual);
                        
                        // Verificar si hay reservaciones activas (hora ya lleg√≥)
                        const reservacionesActivas = reservacionesHoy.filter(r => {
                            return esReservacionPasada(r.hora_reservacion);
                        });
                        
                        // Buscar el elemento DOM de la mesa
                        const mesaElement = document.querySelector(`[data-mesa-id="${mesa.id}"]`);
                        
                        if (mesaElement) {
                            // Agregar o remover √≠cono activo
                            const iconoExistente = mesaElement.querySelector('.mesa-icono-activo');
                            
                            if (reservacionesActivas.length > 0 && !iconoExistente) {
                                // Agregar √≠cono naranja
                                const iconoActivo = document.createElement('div');
                                iconoActivo.className = 'mesa-icono-activo';
                                iconoActivo.style.cssText = `
                                    position: absolute;
                                    top: 6px;
                                    right: 6px;
                                    width: 18px;
                                    height: 18px;
                                    background: #FF9800;
                                    border-radius: 50%;
                                    opacity: 0.8;
                                    animation: pulse-orange 2s infinite;
                                    box-shadow: 0 0 12px rgba(255, 152, 0, 0.6);
                                    z-index: 10;
                                `;
                                mesaElement.appendChild(iconoActivo);
                                console.log(`Punto naranja agregado a mesa ${mesa.numero}`);
                            } else if (reservacionesActivas.length === 0 && iconoExistente) {
                                // Remover √≠cono naranja
                                iconoExistente.remove();
                                console.log(`Punto naranja removido de mesa ${mesa.numero}`);
                            }
                        }
                    } catch (error) {
                        console.error(`Error al verificar reservaciones de mesa ${mesa.id}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error al verificar reservaciones activas:', error);
            }
        }

        // Funci√≥n optimizada para actualizar solo una mesa espec√≠fica
        async function actualizarMesaEspecifica(mesaId, nuevoEstado, fecha = null) {
            try {
                console.time(`Actualizaci√≥n mesa ${mesaId}`);
                
                // Obtener datos actualizados de la mesa espec√≠fica
                const response = await fetch(`/api/mesas/especifica/${mesaId}`);
                if (!response.ok) {
                    throw new Error('Error al obtener datos de la mesa');
                }
                
                const mesaActualizada = await response.json();
                
                // Actualizar la mesa en todasLasMesas
                const indexMesa = todasLasMesas.findIndex(m => m.id === mesaId);
                if (indexMesa !== -1) {
                    todasLasMesas[indexMesa] = mesaActualizada;
                }
                
                // Buscar el elemento DOM de la mesa
                const mesaElement = document.querySelector(`[data-mesa-id="${mesaId}"]`);
                
                // ACTUALIZAR CLASE VISUAL INSTANT√ÅNEAMENTE
                if (mesaElement) {
                    mesaElement.className = `mesa ${mesaActualizada.estado}`;
                    
                    // Mantener estado temporal si existe
                    if (mesaActualizada.estado === 'reservada') {
                        const mesasOcupadasTemp = JSON.parse(localStorage.getItem('mesasOcupadasTemp') || '[]');
                        if (mesasOcupadasTemp.includes(mesaId)) {
                            mesaElement.classList.add('ocupada-temporaria');
                        }
                        
                        // Agregar tooltip si no existe
                        const tooltipExistente = mesaElement.querySelector('.mesa-tooltip');
                        if (!tooltipExistente) {
                            await agregarTooltipReservacion(mesaElement, mesaId);
                        }
                    } else {
                        // Remover tooltip si la mesa ya no est√° reservada
                        const tooltipExistente = mesaElement.querySelector('.mesa-tooltip');
                        if (tooltipExistente) {
                            tooltipExistente.remove();
                        }
                    }
                    
                    // MANEJAR BOTONES DIN√ÅMICAMENTE
                    if (mesaActualizada.estado === 'ocupada') {
                        // Remover opciones de ocupar si existen
                        const opcionesExistentes = mesaElement.querySelector('.mesa-opciones');
                        if (opcionesExistentes) {
                            opcionesExistentes.remove();
                        }
                        
                        // Agregar bot√≥n de liberar si no existe
                        const btnLiberarExistente = mesaElement.querySelector('.btn-liberar');
                        if (!btnLiberarExistente) {
                            const btnLiberar = document.createElement('button');
                            btnLiberar.className = 'btn-liberar';
                            btnLiberar.innerHTML = '<i class="fas fa-door-open"></i>';
                            btnLiberar.onclick = (e) => {
                                e.stopPropagation();
                                e.preventDefault();
                                liberarMesa(mesaId);
                            };
                            mesaElement.appendChild(btnLiberar);
                        }
                    } else if (mesaActualizada.estado === 'disponible') {
                        // Remover bot√≥n de liberar si existe
                        const btnLiberarExistente = mesaElement.querySelector('.btn-liberar');
                        if (btnLiberarExistente) {
                            btnLiberarExistente.remove();
                        }
                        
                        // Remover opciones de ocupar si existen
                        const opcionesExistentes = mesaElement.querySelector('.mesa-opciones');
                        if (opcionesExistentes) {
                            opcionesExistentes.remove();
                        }
                        
                        // RESTAURAR EL EVENTO DE CLIC PARA MESAS DISPONIBLES
                        mesaElement.onclick = () => {
                            // Crear opciones
                            const opciones = document.createElement('div');
                            opciones.className = 'mesa-opciones';
                            
                            let opcionesHTML = `
                                <div class="mesa-opcion ocupar" onclick="event.stopPropagation(); ocuparMesa(${mesaId})">
                                    <i class="fas fa-user-check"></i> Ocupar
                                </div>
                            `;
                            
                            opciones.innerHTML = opcionesHTML;
                            
                            // Remover opciones existentes
                            const opcionesExistentes = mesaElement.querySelector('.mesa-opciones');
                            if (opcionesExistentes) {
                                opcionesExistentes.remove();
                            }
                            
                            mesaElement.appendChild(opciones);
                            
                            // Cerrar opciones al hacer clic fuera
                            const cerrarOpciones = (e) => {
                                if (!mesaElement.contains(e.target)) {
                                    opciones.remove();
                                    document.removeEventListener('click', cerrarOpciones);
                                }
                            };
                            setTimeout(() => {
                                document.addEventListener('click', cerrarOpciones);
                            }, 0);
                        };
                    }
                }
                
                // Verificar reservaciones activas si es necesario
                if (mesaActualizada.estado === 'disponible' || mesaActualizada.estado === 'reservada') {
                    try {
                        const responseReservaciones = await fetch(`/api/reservaciones/mesa/${mesaId}`);
                        const reservaciones = await responseReservaciones.json();
                        
                        // Filtrar reservaciones para hoy
                        const fechaActual = getCurrentDate();
                        const reservacionesHoy = reservaciones.filter(r => r.fecha_reservacion === fechaActual);
                        
                        // Verificar si hay reservaciones activas
                        const reservacionesActivas = reservacionesHoy.filter(r => {
                            return esReservacionPasada(r.hora_reservacion);
                        });
                        
                        // Agregar o remover √≠cono activo
                        const iconoExistente = mesaElement ? mesaElement.querySelector('.mesa-icono-activo') : null;
                        if (mesaElement && reservacionesActivas.length > 0 && !iconoExistente) {
                            const iconoActivo = document.createElement('div');
                            iconoActivo.className = 'mesa-icono-activo';
                            iconoActivo.style.cssText = `
                                position: absolute;
                                top: 6px;
                                right: 6px;
                                width: 18px;
                                height: 18px;
                                background: #FF9800;
                                border-radius: 50%;
                                opacity: 0.8;
                                animation: pulse-orange 2s infinite;
                                box-shadow: 0 0 12px rgba(255, 152, 0, 0.6);
                                z-index: 10;
                            `;
                            mesaElement.appendChild(iconoActivo);
                        } else if (mesaElement && reservacionesActivas.length === 0 && iconoExistente) {
                            iconoExistente.remove();
                        }
                        

                    } catch (error) {
                        console.error('Error al verificar reservaciones:', error);
                    }
                }
            } catch (error) {
                console.error('Error al actualizar la mesa:', error);
                mostrarMensaje('Error al actualizar la mesa');
            } finally {
                console.timeEnd(`Actualizaci√≥n mesa ${mesaId}`);
            }
        }

        function ocuparMesaTemporal(mesaId) {
            // Obtener el elemento de la mesa
            const mesaElement = document.querySelector(`[data-mesa-id="${mesaId}"]`);
            if (!mesaElement) {
                mostrarMensaje('Error: Mesa no encontrada');
                return;
            }
            
            // Agregar la clase para el estado visual
            mesaElement.classList.add('ocupada-temporaria');
            
            // Guardar en localStorage
            const mesasOcupadasTemp = JSON.parse(localStorage.getItem('mesasOcupadasTemp') || '[]');
            if (!mesasOcupadasTemp.includes(mesaId)) {
                mesasOcupadasTemp.push(mesaId);
                localStorage.setItem('mesasOcupadasTemp', JSON.stringify(mesasOcupadasTemp));
            }
            
            // Remover las opciones
            const opciones = mesaElement.querySelector('.mesa-opciones');
            if (opciones) {
                opciones.remove();
            }
            
            mostrarMensaje('Mesa ocupada temporalmente. ¬°Recuerda la RSV!');
        }

        function liberarMesaTemporal(mesaId) {
            // Obtener el elemento de la mesa
            const mesaElement = document.querySelector(`[data-mesa-id="${mesaId}"]`);
            if (!mesaElement) {
                mostrarMensaje('Error: Mesa no encontrada');
                return;
            }
            
            // Remover la clase para el estado visual
            mesaElement.classList.remove('ocupada-temporaria');
            
            // Remover de localStorage
            const mesasOcupadasTemp = JSON.parse(localStorage.getItem('mesasOcupadasTemp') || '[]');
            const index = mesasOcupadasTemp.indexOf(mesaId);
            if (index > -1) {
                mesasOcupadasTemp.splice(index, 1);
                localStorage.setItem('mesasOcupadasTemp', JSON.stringify(mesasOcupadasTemp));
            }
            
            // Remover las opciones
            const opciones = mesaElement.querySelector('.mesa-opciones');
            if (opciones) {
                opciones.remove();
            }
            
            mostrarMensaje('Mesa liberada temporalmente');
        }

        async function agregarTooltipReservacion(mesaElement, mesaId) {
            try {
                // Obtener las reservaciones de la mesa
                const response = await fetch(`/api/reservaciones/mesa/${mesaId}`);
                const reservaciones = await response.json();
                
                // Filtrar reservaciones para hoy
                const fechaActual = await getCurrentDate();
                const reservacionesHoy = reservaciones.filter(r => r.fecha_reservacion === fechaActual);
                
                if (reservacionesHoy.length === 0) return;
                
                // Tomar la primera reservaci√≥n (asumiendo que solo hay una por mesa por d√≠a)
                const reservacion = reservacionesHoy[0];
                
                // Crear el tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'mesa-tooltip';
                
                const horaFormateada = formatTimeForDisplay(reservacion.hora_reservacion);
                
                tooltip.innerHTML = `
                    <div class="mesa-tooltip-content">
                        <div class="mesa-tooltip-title">
                            <i class="fas fa-clock"></i> RSV - ${horaFormateada}
                        </div>
                        <div class="mesa-tooltip-info">
                            <i class="fas fa-user"></i>
                            <span>${reservacion.nombre_reservador}</span>
                            <i class="fas fa-users"></i>
                            <span>${reservacion.cantidad_personas}p</span>
                            ${reservacion.telefono ? `<i class="fas fa-phone"></i><span>${reservacion.telefono}</span>` : ''}
                        </div>
                        ${reservacion.nota ? `
                        <div class="mesa-tooltip-nota">
                            <i class="fas fa-sticky-note"></i>
                            <span>${reservacion.nota.substring(0, 30)}${reservacion.nota.length > 30 ? '...' : ''}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Agregar el tooltip al elemento de la mesa
                mesaElement.appendChild(tooltip);
                
                // Eventos para mostrar/ocultar el tooltip
                let timeoutId;
                
                mesaElement.addEventListener('mouseenter', () => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        tooltip.classList.add('show');
                    }, 300); // Peque√±o delay para evitar tooltips accidentales
                });
                
                mesaElement.addEventListener('mouseleave', () => {
                    clearTimeout(timeoutId);
                    tooltip.classList.remove('show');
                });
                
            } catch (error) {
                console.error('Error al agregar tooltip de reservaci√≥n:', error);
            }
        }

        function cambiarEstadoMesa(mesaId, estadoActual) {
            const estados = ['disponible', 'ocupada'];
            const nuevoEstado = estados[(estados.indexOf(estadoActual) + 1) % estados.length];
            
            fetch(`/api/mesas/${mesaId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ estado: nuevoEstado })
            })
            .then(response => response.json())
            .then(() => cargarMesasSinGuardar());
        }



        // Funci√≥n para seleccionar ocasi√≥n predefinida
        function seleccionarOcasion(ocasion) {
            const notaInput = document.getElementById('notaReservacion');
            notaInput.value = ocasion;
            
            // Cambiar el estado de los botones
            document.querySelectorAll('.row .col-3 .btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'btn-secondary');
                btn.classList.add('btn-outline-primary', 'btn-outline-secondary');
            });
            
            // Marcar el bot√≥n seleccionado
            event.target.classList.remove('btn-outline-primary', 'btn-outline-secondary');
            event.target.classList.add('btn-primary');
            
            // Deshabilitar el textarea para evitar edici√≥n manual
            notaInput.readOnly = true;
            notaInput.style.backgroundColor = '#f8f9fa';
        }

        // Funci√≥n para activar input manual de ocasi√≥n
        function activarInputOcasion() {
            const notaInput = document.getElementById('notaReservacion');
            
            // Limpiar el valor
            notaInput.value = '';
            
            // Habilitar el textarea
            notaInput.readOnly = false;
            notaInput.style.backgroundColor = '';
            notaInput.focus();
            
            // Resetear todos los botones
            document.querySelectorAll('.row .col-3 .btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'btn-secondary');
                btn.classList.add('btn-outline-primary', 'btn-outline-secondary');
            });
            
            // Marcar el bot√≥n "Otro" como seleccionado
            event.target.classList.remove('btn-outline-secondary');
            event.target.classList.add('btn-secondary');
        }
    </script>
</body>
</html>